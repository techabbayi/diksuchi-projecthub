/**\n * Analytics Integration Examples for ProjectHUB\n * \n * This file demonstrates how to integrate the analytics tracking\n * into your existing project routes and controllers.\n */\n\n// ============================================================================\n// EXAMPLE 1: Track Project Views in Project Details Route\n// ============================================================================\n\nimport express from 'express';\nimport Project from '../models/Project.js';\nimport { trackInteraction, trackProjectView } from '../middleware/analytics.js';\nimport { protect } from '../middleware/auth.js';\n\nconst projectRouter = express.Router();\n\n/**\n * GET /api/projects/:id\n * Get project details and track the view\n */\nprojectRouter.get(\n    '/:id',\n    trackInteraction('view'),  // Setup tracking context\n    async (req, res) => {\n        try {\n            const project = await Project.findById(req.params.id).populate('author', 'username avatar');\n\n            if (!project) {\n                return res.status(404).json({\n                    success: false,\n                    message: 'Project not found'\n                });\n            }\n\n            // Track the view\n            await trackProjectView(req.params.id, req);\n\n            // Increment view counter on the project\n            project.incrementViews(true);\n\n            res.json({\n                success: true,\n                data: project\n            });\n        } catch (error) {\n            console.error('Get project error:', error);\n            res.status(500).json({\n                success: false,\n                message: error.message\n            });\n        }\n    }\n);\n\n// ============================================================================\n// EXAMPLE 2: Track Project Downloads\n// ============================================================================\n\nimport { trackProjectDownload } from '../middleware/analytics.js';\nimport fs from 'fs';\nimport path from 'path';\n\n/**\n * POST /api/projects/:id/download\n * Download project files and track the download\n */\nprojectRouter.post(\n    '/:id/download',\n    protect,\n    trackInteraction('download'),\n    async (req, res) => {\n        try {\n            const project = await Project.findById(req.params.id);\n\n            if (!project) {\n                return res.status(404).json({\n                    success: false,\n                    message: 'Project not found'\n                });\n            }\n\n            // Check if user has access (for paid projects)\n            if (project.type === 'paid') {\n                // Verify user has purchased this project\n                const hasPurchased = await verifyUserPurchase(req.user._id, project._id);\n                if (!hasPurchased) {\n                    return res.status(403).json({\n                        success: false,\n                        message: 'You do not have access to this project'\n                    });\n                }\n            }\n\n            let downloadPath, fileName;\n            let fileSize = 0;\n\n            // Get file path based on project mode\n            if (project.mode === 'zip') {\n                // Download from zipUrl (e.g., from cloud storage)\n                fileName = `${project.title}.zip`;\n                // For actual implementation, you might redirect to zipUrl\n                // or download and stream the file\n            } else if (project.mode === 'github') {\n                // Provide GitHub link\n                fileName = project.githubLink;\n            }\n\n            // Track successful download\n            await trackProjectDownload(\n                req.params.id,\n                {\n                    success: true,\n                    type: project.mode,\n                    size: fileSize,\n                    fileName: fileName\n                },\n                req\n            );\n\n            // Increment download counter\n            await project.incrementDownloads(true);\n\n            // Return download link or stream file\n            res.json({\n                success: true,\n                message: 'Download initiated',\n                data: {\n                    fileName: fileName,\n                    url: project.zipUrl || project.githubLink\n                }\n            });\n\n        } catch (error) {\n            console.error('Download error:', error);\n\n            // Track failed download\n            await trackProjectDownload(\n                req.params.id,\n                {\n                    success: false,\n                    type: req.body.mode || 'unknown'\n                },\n                req\n            );\n\n            res.status(500).json({\n                success: false,\n                message: error.message\n            });\n        }\n    }\n);\n\n// ============================================================================\n// EXAMPLE 3: Server.js Integration\n// ============================================================================\n\n/**\n * In your backend/server.js file, add the analytics middleware:\n * \n * // After express and bodyParser setup:\n * import express from 'express';\n * import bodyParser from 'body-parser';\n * import { trackPageVisit } from './middleware/analytics.js';\n * \n * const app = express();\n * \n * // Middleware\n * app.use(bodyParser.json());\n * app.use(bodyParser.urlencoded({ extended: true }));\n * \n * // Add analytics middleware here (BEFORE your routes)\n * app.use(trackPageVisit);\n * \n * // Your routes\n * app.use('/api/projects', projectRouter);\n * app.use('/api/admin', adminRouter);\n * \n * // ... rest of server setup\n */\n\n// ============================================================================\n// EXAMPLE 4: Update Project Analytics from Raw Data\n// ============================================================================\n\n/**\n * Periodically update project analytics metadata from raw analytics\n * This could be run as a scheduled job\n */\nexpport const updateProjectAnalyticsFromData = async () => {\n    try {\n        const projects = await Project.find({ status: 'approved' });\n\n        for (const project of projects) {\n            // Get views by country and device\n            const Analytics = require('../models/Analytics.js').default;\n            const deviceBreakdown = await Analytics.aggregate([\n                {\n                    $match: {\n                        resourceId: project._id,\n                        type: 'view'\n                    }\n                },\n                {\n                    $group: {\n                        _id: '$device',\n                        count: { $sum: 1 }\n                    }\n                },\n                { $sort: { count: -1 } },\n                { $limit: 5 }\n            ]);\n\n            const countryBreakdown = await Analytics.aggregate([\n                {\n                    $match: {\n                        resourceId: project._id,\n                        type: 'view'\n                    }\n                },\n                {\n                    $group: {\n                        _id: '$country',\n                        count: { $sum: 1 }\n                    }\n                },\n                { $sort: { count: -1 } },\n                { $limit: 5 }\n            ]);\n\n            const sourceBreakdown = await Analytics.aggregate([\n                {\n                    $match: {\n                        resourceId: project._id,\n                        type: 'view'\n                    }\n                },\n                {\n                    $group: {\n                        _id: '$source',\n                        count: { $sum: 1 }\n                    }\n                },\n                { $sort: { count: -1 } },\n                { $limit: 5 }\n            ]);\n\n            // Update project with analytics data\n            project.updateAnalyticsFromData({\n                topDevices: deviceBreakdown.map(d => ({\n                    device: d._id,\n                    count: d.count\n                })),\n                topCountries: countryBreakdown.map(c => ({\n                    country: c._id,\n                    count: c.count\n                })),\n                topSources: sourceBreakdown.map(s => ({\n                    source: s._id,\n                    count: s.count\n                }))\n            });\n        }\n\n        console.log('✅ Project analytics updated successfully');\n    } catch (error) {\n        console.error('Error updating project analytics:', error);\n    }\n};\n\n// ============================================================================\n// EXAMPLE 5: Frontend Route Integration\n// ============================================================================\n\n/**\n * In your frontend router (React Router):\n * \n * import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';\n * import AnalyticsPage from './pages/AnalyticsPage';\n * import AdminDashboard from './pages/AdminDashboard';\n * \n * function AppRouter() {\n *   return (\n *     <Router>\n *       <Routes>\n *         {/* Existing routes... */}\n *         \n *         {/* Admin Analytics Route */}\n *         <Route path=\"/admin/analytics\" element={<AnalyticsPage />} />\n *         \n *         {/* Existing admin routes... */}\n *       </Routes>\n *     </Router>\n *   );\n * }\n */\n\n// ============================================================================\n// EXAMPLE 6: Analytics Dashboard Queries (Frontend)\n// ============================================================================\n\n/**\n * Frontend examples for querying analytics\n */\n\n// Get comprehensive analytics for last 30 days\nexport const getAnalytics30Days = async () => {\n    const response = await fetch('/api/admin/analytics?timeframe=30d');\n    const data = await response.json();\n    return data.data;\n};\n\n// Get analytics for custom date range\nexport const getAnalyticsDateRange = async (startDate, endDate) => {\n    const response = await fetch(\n        `/api/admin/analytics?startDate=${startDate}&endDate=${endDate}`\n    );\n    const data = await response.json();\n    return data.data;\n};\n\n// Get specific project analytics\nexport const getProjectAnalytics = async (projectId) => {\n    const response = await fetch(\n        `/api/admin/analytics/projects?projectId=${projectId}`\n    );\n    const data = await response.json();\n    return data.data;\n};\n\n// Get browse projects page analytics\nexport const getBrowseProjectsAnalytics = async () => {\n    const response = await fetch('/api/admin/analytics/browse-projects');\n    const data = await response.json();\n    return data.data;\n};\n\n// Get specific page analytics\nexport const getPageAnalytics = async (page) => {\n    const response = await fetch(`/api/admin/analytics/pages?page=${page}`);\n    const data = await response.json();\n    return data.data;\n};\n\n// ============================================================================\n// EXAMPLE 7: Scheduled Jobs for Analytics Maintenance\n// ============================================================================\n\n/**\n * Install node-schedule: npm install node-schedule\n * \n * In your server.js or a separate jobs.js file:\n */\n\nimport schedule from 'node-schedule';\nimport { cleanupAnalyticsData } from '../middleware/analytics.js';\nimport Project from '../models/Project.js';\n\n// Clean up old analytics data daily at 2 AM\nexport const scheduleAnalyticsCleanup = () => {\n    schedule.scheduleJob('0 2 * * *', async () => {\n        try {\n            console.log('Running analytics cleanup...');\n            const result = await cleanupAnalyticsData(730); // 2 years\n            console.log(\n                `✅ Cleanup complete: Removed ${result.analytics} analytics records and ${result.pageVisits} page visit records`\n            );\n        } catch (error) {\n            console.error('❌ Analytics cleanup failed:', error);\n        }\n    });\n};\n\n// Reset daily analytics counters at midnight\nexport const scheduleAnalyticsReset = () => {\n    schedule.scheduleJob('0 0 * * *', async () => {\n        try {\n            console.log('Resetting daily analytics counters...');\n            await Project.resetPeriodCounters('daily');\n            console.log('✅ Daily counters reset');\n        } catch (error) {\n            console.error('❌ Failed to reset daily counters:', error);\n        }\n    });\n\n    schedule.scheduleJob('0 0 * * 0', async () => {\n        try {\n            console.log('Resetting weekly analytics counters...');\n            await Project.resetPeriodCounters('weekly');\n            console.log('✅ Weekly counters reset');\n        } catch (error) {\n            console.error('❌ Failed to reset weekly counters:', error);\n        }\n    });\n\n    schedule.scheduleJob('0 0 1 * *', async () => {\n        try {\n            console.log('Resetting monthly analytics counters...');\n            await Project.resetPeriodCounters('monthly');\n            console.log('✅ Monthly counters reset');\n        } catch (error) {\n            console.error('❌ Failed to reset monthly counters:', error);\n        }\n    });\n};\n\n// Initialize scheduled jobs\nexport const initializeAnalyticsJobs = () => {\n    scheduleAnalyticsCleanup();\n    scheduleAnalyticsReset();\n    console.log('✅ Analytics jobs scheduled');\n};\n\nexport default projectRouter;