#!/usr/bin/env node

/**
 * Analytics Setup Script for ProjectHUB
 * This script helps integrate the analytics system into the existing ProjectHUB setup
 */

import fs from 'fs'; \nimport path from 'path'; \nimport { fileURLToPath } from 'url'; \n\nconst __dirname = path.dirname(fileURLToPath(import.meta.url)); \n\nconsole.log('\\n=== ProjectHUB Analytics Setup Script ===\\n'); \n\n// Step 1: Check dependencies\nconsole.log('Step 1: Checking dependencies...');\nconst requiredPackages = ['ua-parser-js', 'geoip-lite', 'uuid'];\nconst backendPackageJson = JSON.parse(\n    fs.readFileSync(path.join(__dirname, 'backend', 'package.json'), 'utf8')\n);\n\nconst missingPackages = requiredPackages.filter(\n    pkg => !backendPackageJson.dependencies[pkg]\n);\n\nif (missingPackages.length > 0) {\n    console.log('\\n❌ Missing packages in backend/package.json:');\n    missingPackages.forEach(pkg => console.log(`   - ${pkg}`));\n    console.log('\\nInstall with: npm install ' + missingPackages.join(' '));\n} else {\n    console.log('✅ All required packages found');\n}\n\n// Step 2: Check if analytics models exist\nconsole.log('\\nStep 2: Checking analytics models...');\nconst modelsDir = path.join(__dirname, 'backend', 'models');\nconst analyticsModelExists = fs.existsSync(path.join(modelsDir, 'Analytics.js'));\nconst pageVisitModelExists = fs.existsSync(path.join(modelsDir, 'PageVisit.js'));\n\nif (analyticsModelExists && pageVisitModelExists) {\n    console.log('✅ Analytics models found');\n} else {\n    console.log('❌ Missing analytics models');\n}\n\n// Step 3: Check if analytics middleware exists\nconsole.log('\\nStep 3: Checking analytics middleware...');\nconst middlewareDir = path.join(__dirname, 'backend', 'middleware');\nconst analyticsMiddlewareExists = fs.existsSync(path.join(middlewareDir, 'analytics.js'));\n\nif (analyticsMiddlewareExists) {\n    console.log('✅ Analytics middleware found');\n} else {\n    console.log('❌ Missing analytics middleware');\n}\n\n// Step 4: Check server.js integration\nconsole.log('\\nStep 4: Checking server integration...');\nconst serverPath = path.join(__dirname, 'backend', 'server.js');\nconst serverContent = fs.readFileSync(serverPath, 'utf8');\nconst hasAnalyticsImport = serverContent.includes('trackPageVisit') || serverContent.includes('analytics');\n\nif (hasAnalyticsImport) {\n    console.log('✅ Analytics middleware appears to be integrated in server.js');\n} else {\n    console.log('⚠️  Analytics middleware not yet integrated in server.js');\n    console.log('\\nTo integrate, add to your server.js:');\n    console.log(\n        `\n// After body parser middleware, add:\nimport { trackPageVisit } from './middleware/analytics.js';\n\napp.use(trackPageVisit);\n    `\n    );\n}\n\n// Step 5: Check admin routes\nconsole.log('\\nStep 5: Checking admin routes...');\nconst adminRoutesPath = path.join(__dirname, 'backend', 'routes', 'adminRoutes.js');\nconst adminRoutesContent = fs.readFileSync(adminRoutesPath, 'utf8');\nconst hasNewAnalyticsEndpoints = adminRoutesContent.includes('getProjectAnalytics') && adminRoutesContent.includes('getBrowseProjectsAnalytics');\n\nif (hasNewAnalyticsEndpoints) {\n    console.log('✅ New analytics endpoints are configured');\n} else {\n    console.log('⚠️  New analytics endpoints not yet in adminRoutes.js');\n}\n\n// Step 6: Check frontend page exists\nconsole.log('\\nStep 6: Checking frontend analytics page...');\nconst analyticsPagePath = path.join(__dirname, 'frontend', 'src', 'pages', 'AnalyticsPage.jsx');\nconst analyticsPageExists = fs.existsSync(analyticsPagePath);\n\nif (analyticsPageExists) {\n    console.log('✅ AnalyticsPage component found');\n} else {\n    console.log('❌ AnalyticsPage component not found');\n}\n\n// Step 7: Check frontend recharts dependency\nconsole.log('\\nStep 7: Checking frontend dependencies...');\nconst frontendPackageJson = JSON.parse(\n    fs.readFileSync(path.join(__dirname, 'frontend', 'package.json'), 'utf8')\n);\n\nif (frontendPackageJson.dependencies['recharts']) {\n    console.log('✅ Recharts library found');\n} else {\n    console.log('⚠️  Recharts not installed in frontend');\n    console.log('   Install with: npm install recharts');\n}\n\n// Summary\nconsole.log('\\n=== Setup Summary ===\\n');\nconsole.log('Analytics System Components:');\nconsole.log(`  ✅ Analytics Model: ${analyticsModelExists ? 'Present' : 'MISSING'}`);\nconsole.log(`  ✅ PageVisit Model: ${pageVisitModelExists ? 'Present' : 'MISSING'}`);\nconsole.log(`  ✅ Analytics Middleware: ${analyticsMiddlewareExists ? 'Present' : 'MISSING'}`);\nconsole.log(`  ✅ Admin Routes Updated: ${hasNewAnalyticsEndpoints ? 'Yes' : 'No'}`);\nconsole.log(`  ✅ Frontend Component: ${analyticsPageExists ? 'Present' : 'MISSING'}`);\nconsole.log(`  ✅ Frontend Dependencies: ${frontendPackageJson.dependencies['recharts'] ? 'Installed' : 'Missing'}`);\n\nconsole.log('\\n=== Next Steps ===\\n');\nconsole.log('1. Install backend dependencies:');\nconsole.log('   cd backend && npm install ua-parser-js geoip-lite uuid');\n\nconsole.log('\\n2. Install frontend dependencies:');\nconsole.log('   cd frontend && npm install recharts');\n\nconsole.log('\\n3. Add analytics middleware to backend/server.js:');\nconsole.log('   import { trackPageVisit } from \"./middleware/analytics.js\";');\nconsole.log('   app.use(trackPageVisit); // After body parser');\n\nconsole.log('\\n4. Add analytics route to your frontend router');\n\nconsole.log('\\n5. Start tracking events in your routes:');\nconsole.log('   import { trackProjectView } from \"./middleware/analytics.js\";');\nconsole.log('   await trackProjectView(projectId, req);');\n\nconsole.log('\\n6. Access analytics at: /admin/analytics');\n\nconsole.log('\\nFor detailed documentation, see: ANALYTICS_DOCUMENTATION.md\\n');\n